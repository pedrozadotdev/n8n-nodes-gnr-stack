:80 {

	rewrite /n8n /n8n/

	handle_path /n8n/* {
		uri strip_prefix /n8n
		# Fix custom node icons when using N8N_PATH
		uri replace icons/CUSTOM/home/node/.n8n/custom/ icons/CUSTOM/
    reverse_proxy n8n:5678 {
			header_up X-Real-IP {remote_host}
	  }
	}

	handle /protected {
		forward_auth n8n:5678 {
			uri /webhook/{$WEBHOOK_ID}/check
			copy_headers X-Forwarded-User
		}
	}

	handle /login {
		uri replace login webhook/{$WEBHOOK_ID}/login
		reverse_proxy n8n:5678 {
			header_up X-Real-IP {remote_host}
		}
	}

	handle /logout {
		uri replace logout webhook/{$WEBHOOK_ID}/logout
		reverse_proxy n8n:5678
	}

  reverse_proxy whoami:80
}
